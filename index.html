<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EFT Dashboard Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0b0b0b; --card: #161616; --accent: #ffae00; --text: #f0f0f0; --border: #333; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* ステータスパネル */
        .status-bar { background: #000; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .mode-switch { display: flex; background: var(--card); padding: 4px; border-radius: 8px; }
        .mode-btn { padding: 6px 15px; border: none; border-radius: 4px; cursor: pointer; color: #666; background: transparent; transition: 0.3s; }
        .mode-btn.active { background: var(--accent); color: #000; font-weight: bold; }
        .update-time { font-size: 12px; color: #888; }

        /* メインレイアウト */
        .main-content { display: grid; grid-template-columns: 320px 1fr; flex: 1; overflow: hidden; }

        /* 左サイド：検索・リスト */
        .sidebar { border-right: 1px solid var(--border); display: flex; flex-direction: column; background: #0f0f0f; }
        .filter-section { padding: 15px; border-bottom: 1px solid var(--border); }
        input, select { width: 100%; background: var(--card); border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        
        .item-list { overflow-y: auto; flex: 1; }
        .item-row { padding: 10px 15px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .item-row:hover { background: #1a1a1a; }
        .item-row img { width: 32px; height: 32px; background: #222; border-radius: 4px; }
        .fav-star { color: #444; margin-left: auto; cursor: pointer; font-size: 18px; }
        .fav-star.active { color: var(--accent); }

        /* 右サイド：詳細表示 */
        .detail-view { padding: 20px; overflow-y: auto; }
        .detail-header { display: grid; grid-template-columns: 140px 1fr; gap: 20px; margin-bottom: 20px; }
        .big-icon { width: 140px; height: 140px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 10px; object-fit: contain; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .stat-card { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 20px; font-weight: bold; color: var(--accent); margin-top: 5px; }
        
        .chart-box { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 20px; height: 400px; margin-top: 20px; }
    </style>
</head>
<body>

<div class="status-bar">
    <div class="mode-switch">
        <button id="pvpBtn" class="mode-btn active" onclick="setMode('pvp')">PvP</button>
        <button id="pveBtn" class="mode-btn" onclick="setMode('pve')">PvE</button>
    </div>
    <div class="update-time">最終更新: <span id="lastUpdate">-</span></div>
</div>

<div class="main-content">
    <div class="sidebar">
        <div class="filter-section">
            <input type="text" id="searchInput" placeholder="アイテム名で検索..." oninput="renderList()">
            <select id="catSelect" onchange="renderList()">
                <option value="">すべてのカテゴリ</option>
            </select>
            <label style="font-size: 12px;"><input type="checkbox" id="favOnly" onchange="renderList()"> お気に入りのみ</label>
        </div>
        <div id="itemList" class="item-list"></div>
    </div>

    <div class="detail-view" id="detailView" style="display:none;">
        <div class="detail-header">
            <img id="mainIcon" src="" class="big-icon">
            <div>
                <h2 id="mainName" style="margin:0 0 10px 0;">アイテム名</h2>
                <div class="stat-grid">
                    <div class="stat-card">現在値<div id="curPrice" class="stat-val">-</div></div>
                    <div class="stat-card">期間内最高<div id="maxPrice" class="stat-val">-</div></div>
                    <div class="stat-card">期間内最低<div id="minPrice" class="stat-val">-</div></div>
                </div>
            </div>
        </div>
        <div class="chart-box"><canvas id="mainChart"></canvas></div>
    </div>
</div>

<script>
    let rawData = [];
    let currentMode = 'pvp';
    let chart = null;
    let favorites = JSON.parse(localStorage.getItem('eft_favs') || '[]');

    const trans = {
        "Arm Band": "腕章", "Armor Plate": "アーマープレート", "Auxiliary Mod": "補助パーツ",
        "Compass": "コンパス", "Face Cover": "フェイスカバー", "Flyer": "チラシ",
        "Fuel": "燃料", "Headwear": "ヘッドウェア", "Keycard": "キーカード",
        "Marksman rifle": "マークスマンライフル", "Mechanical Key": "メカニカルキー",
        "Multitools": "マルチツール", "Night Vision": "ナイトビジョン", "Other": "その他",
        "Portable Range Finder": "レンジファインダー", "Repair Kits": "修理キット",
        "Revolver": "リボルバー", "Spring Driven Cylinder": "シリンダー",
        "Stimulant": "注入器(スティム)", "Thermal Vision": "サーマルビジョン"
    };

    async function loadData() {
        const res = await fetch(`data-${currentMode}.json`);
        rawData = await res.json();
        const latest = rawData[rawData.length - 1];
        document.getElementById('lastUpdate').innerText = new Date(latest.time).toLocaleString();
        
        initCats(latest.items);
        renderList();
    }

    function initCats(items) {
        const cats = new Set();
        items.forEach(i => cats.add(trans[i.category?.name] || i.category?.name || "その他"));
        const sel = document.getElementById('catSelect');
        sel.innerHTML = '<option value="">すべてのカテゴリ</option>';
        Array.from(cats).sort().forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
    }

    function toggleFav(id, e) {
        e.stopPropagation();
        if(favorites.includes(id)) favorites = favorites.filter(f => f !== id);
        else favorites.push(id);
        localStorage.setItem('eft_favs', JSON.stringify(favorites));
        renderList();
    }

    function renderList() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('catSelect').value;
        const favOnly = document.getElementById('favOnly').checked;
        const listDiv = document.getElementById('itemList');
        
        const latestItems = rawData[rawData.length - 1].items;
        const filtered = latestItems.filter(i => {
            const cName = trans[i.category?.name] || i.category?.name || "その他";
            const isFav = favorites.includes(i.id);
            return i.name.toLowerCase().includes(search) && (!cat || cName === cat) && (!favOnly || isFav);
        });

        listDiv.innerHTML = '';
        filtered.sort((a,b) => a.name.localeCompare(b.name, 'ja')).forEach(i => {
            const isFav = favorites.includes(i.id);
            listDiv.innerHTML += `
                <div class="item-row" onclick="showDetail('${i.id}')">
                    <img src="images/${i.id}.png" onerror="this.src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII='">
                    <span style="font-size:13px">${i.name}</span>
                    <span class="fav-star ${isFav?'active':''}" onclick="toggleFav('${i.id}', event)">★</span>
                </div>`;
        });
    }

    function setMode(m) {
        currentMode = m;
        document.getElementById('pvpBtn').classList.toggle('active', m === 'pvp');
        document.getElementById('pveBtn').classList.toggle('active', m === 'pve');
        loadData();
    }

    function showDetail(id) {
        document.getElementById('detailView').style.display = 'block';
        const labels = [], prices = [];
        let name = "", cat = "";

        rawData.forEach(entry => {
            const item = entry.items.find(i => i.id === id);
            if(item) {
                labels.push(new Date(entry.time).toLocaleString('ja-JP', {month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'}));
                prices.push(item.lastLowPrice);
                name = item.name;
                cat = trans[item.category?.name] || item.category?.name;
            }
        });

        document.getElementById('mainIcon').src = `images/${id}.png`;
        document.getElementById('mainName').innerText = name;
        document.getElementById('curPrice').innerText = prices[prices.length-1].toLocaleString() + " ₽";
        document.getElementById('maxPrice').innerText = Math.max(...prices).toLocaleString() + " ₽";
        document.getElementById('minPrice').innerText = Math.min(...prices).toLocaleString() + " ₽";

        if(chart) chart.destroy();
        chart = new Chart(document.getElementById('mainChart'), {
            type: 'line',
            data: { labels, datasets: [{ label: 'Price', data: prices, borderColor: '#ffae00', tension: 0.1, fill: true, backgroundColor: 'rgba(255,174,0,0.05)' }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { grid: { color: '#222' } }, x: { grid: { display: false } } } }
        });
    }

    loadData();
</script>
</body>
</html>
