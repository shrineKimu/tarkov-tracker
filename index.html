<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EFT Market Tracker Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-color: #0c0c0c;
            --card-bg: #161616;
            --accent: #e59322;
            --text: #d0d0d0;
            --border: #2a2a2a;
            --success: #00ff88;
            --warning: #ffca28;
            --modal-bg: rgba(0, 0, 0, 0.9);
        }

        body { font-family: sans-serif; background-color: var(--bg-color); color: var(--text); margin: 0; padding: 10px; }
        h1 { text-align: center; color: var(--accent); font-size: 1.5em; letter-spacing: 3px; margin: 10px 0; }

        .controls {
            max-width: 1000px; margin: 0 auto 20px; display: flex; flex-direction: column; gap: 15px;
            background: #1e1e1e; padding: 15px; border-radius: 12px; border: 1px solid var(--border);
        }

        .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .search-input { flex: 2; min-width: 200px; padding: 10px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-color); color: #fff; }
        select, .btn { padding: 10px; background: var(--bg-color); color: #fff; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; }

        .btn-group { display: flex; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; }
        .mode-btn { border: none; padding: 10px 20px; background: #252525; color: #888; cursor: pointer; }
        .mode-btn.active { background: var(--accent); color: #000; font-weight: bold; }

        .item-list { max-width: 1000px; margin: 0 auto; display: flex; flex-direction: column; gap: 8px; }
        
        .item-row {
            display: grid;
            grid-template-columns: 40px 60px 1fr 80px 140px 140px;
            align-items: center; background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 6px; padding: 8px 15px; gap: 15px; cursor: pointer; transition: 0.2s;
        }
        .item-row:hover { border-color: var(--accent); background: #222; }

        .item-icon { width: 45px; height: 45px; object-fit: contain; }
        .item-name { font-size: 0.9em; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .price-group { display: flex; flex-direction: column; align-items: flex-end; }
        .price-label { font-size: 0.6em; color: #666; }
        .price-val { font-family: monospace; font-weight: bold; font-size: 1.05em; }
        .per-slot { font-size: 0.7em; color: #888; }
        
        .flea-color { color: var(--success); }
        .trader-high { color: var(--warning); }
        .slot-badge { background: #333; color: #ccc; padding: 2px 6px; border-radius: 4px; font-size: 0.75em; text-align: center; }

        /* モーダル表示用 */
        #modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-bg); z-index: 100; justify-content: center; align-items: center;
        }
        .modal-content {
            background: #1a1a1a; padding: 25px; border-radius: 15px; border: 1px solid var(--accent);
            width: 95%; max-width: 600px; position: relative; max-height: 90vh; overflow-y: auto;
        }
        .close-btn { position: absolute; top: 10px; right: 20px; font-size: 28px; cursor: pointer; color: #888; }
        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
        .stat-box { background: #111; padding: 12px; border-radius: 8px; border: 1px solid #333; }
        .stat-label { font-size: 0.7em; color: #888; display: block; margin-bottom: 5px; }
        .stat-value { font-size: 1.1em; font-weight: bold; font-family: monospace; }
        canvas { background: #111; border-radius: 8px; padding: 10px; margin-top: 15px; }
    </style>
</head>
<body>

    <h1>EFT MARKET TRACKER</h1>

    <div class="controls">
        <div class="row">
            <input type="text" id="searchInput" class="search-input" placeholder="アイテム名で検索...">
            <div class="btn-group">
                <button id="pvpBtn" class="mode-btn active">PVP</button>
                <button id="pveBtn" class="mode-btn">PVE</button>
            </div>
        </div>
        <div class="row">
            <select id="sortSelect">
                <option value="flea_per_slot">フリマ効率順</option>
                <option value="trader_per_slot">店売り効率順</option>
                <option value="flea_price">フリマ総額順</option>
                <option value="trader_price">店売り総額順</option>
            </select>
            <button id="favFilterBtn" class="btn">★ お気に入りのみ</button>
        </div>
    </div>

    <div id="itemList" class="item-list"></div>

    <div id="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <div id="modalBody"></div>
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <script>
        let allItems = [];
        let favorites = JSON.parse(localStorage.getItem('eft_favs') || '[]');
        let currentMode = 'pvp';
        let showOnlyFav = false;
        let chartInstance = null;

        async function loadData() {
            try {
                const [dataRes, listRes] = await Promise.all([
                    fetch(`data-${currentMode}.json`),
                    fetch(`list-${currentMode}.json`)
                ]);
                const dataJson = await dataRes.json();
                const listJson = await listRes.json();
                const infoMap = {};
                listJson.items.forEach(i => infoMap[i.id] = i);

                allItems = Object.entries(dataJson.data).map(([id, info]) => {
                    const detail = infoMap[id] || {};
                    const flea = info.cp || 0;
                    const trader = detail.bestTraderPrice || 0;
                    const slots = detail.slots || 1;
                    return {
                        id,
                        name: info.n,
                        fleaPrice: flea,
                        traderPrice: trader,
                        traderName: detail.bestTraderName || "---",
                        slots,
                        fleaPerSlot: Math.floor(flea / slots),
                        traderPerSlot: Math.floor(trader / slots),
                        img: `https://assets.tarkov.dev/${id}-512.webp`,
                        history: info.h || []
                    };
                });
                render();
            } catch (e) { console.error(e); }
        }

        function showDetail(id) {
            const item = allItems.find(i => i.id === id);
            const prices = item.history.map(h => h.p);
            const max = Math.max(...prices);
            const min = Math.min(...prices);
            const avg = Math.floor(prices.reduce((a, b) => a + b, 0) / (prices.length || 1));
            const volatility = avg > 0 ? (((max - min) / avg) * 100).toFixed(1) : 0;

            document.getElementById('modalBody').innerHTML = `
                <div style="display:flex; align-items:center; gap:20px;">
                    <img src="${item.img}" style="width:70px; height:70px; object-fit:contain;">
                    <div>
                        <h2 style="margin:0; color:var(--accent); font-size:1.2em;">${item.name}</h2>
                        <div style="color:#666; font-size:0.8em; margin-top:5px;">${item.slots} 枠 | @${item.fleaPerSlot.toLocaleString()} (効率)</div>
                    </div>
                </div>
                <div class="stat-grid">
                    <div class="stat-box"><span class="stat-label">7日間 最高</span><span class="stat-value flea-color">${max.toLocaleString()}</span></div>
                    <div class="stat-box"><span class="stat-label">7日間 最低</span><span class="stat-value trader-high">${min.toLocaleString()}</span></div>
                    <div class="stat-box"><span class="stat-label">7日間 平均</span><span class="stat-value">${avg.toLocaleString()}</span></div>
                    <div class="stat-box"><span class="stat-label">変動率</span><span class="stat-value" style="color:${volatility > 30 ? 'var(--warning)' : 'var(--success)'}">${volatility}%</span></div>
                </div>
            `;
            document.getElementById('modal').style.display = 'flex';
            if (chartInstance) chartInstance.destroy();
            const ctx = document.getElementById('priceChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: item.history.map(h => new Date(h.t).getHours() + ":00"),
                    datasets: [{
                        label: 'Price',
                        data: prices,
                        borderColor: '#e59322',
                        backgroundColor: 'rgba(229, 147, 34, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { grid: { color: '#222' }, ticks: { color: '#888' } } } }
            });
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        function toggleFav(e, id) {
            e.stopPropagation();
            const idx = favorites.indexOf(id);
            if (idx > -1) favorites.splice(idx, 1); else favorites.push(id);
            localStorage.setItem('eft_favs', JSON.stringify(favorites));
            render();
        }

        function render() {
            const listDiv = document.getElementById('itemList');
            const query = document.getElementById('searchInput').value.toLowerCase();
            const sortVal = document.getElementById('sortSelect').value;
            listDiv.innerHTML = '';

            let filtered = allItems.filter(item => {
                const isFav = favorites.includes(item.id);
                return (showOnlyFav ? isFav : true) && item.name.toLowerCase().includes(query);
            });

            filtered.sort((a, b) => {
                const aFav = favorites.includes(a.id) ? 1 : 0;
                const bFav = favorites.includes(b.id) ? 1 : 0;
                if (aFav !== bFav) return bFav - aFav;
                if (sortVal === 'flea_per_slot') return b.fleaPerSlot - a.fleaPerSlot;
                if (sortVal === 'trader_per_slot') return b.traderPerSlot - a.traderPerSlot;
                if (sortVal === 'flea_price') return b.fleaPrice - a.fleaPrice;
                if (sortVal === 'trader_price') return b.traderPrice - a.traderPrice;
                return 0;
            });

            filtered.forEach(item => {
                const isFav = favorites.includes(item.id);
                const isTraderBetter = item.traderPerSlot >= item.fleaPerSlot;
                const row = document.createElement('div');
                row.className = 'item-row';
                row.onclick = () => showDetail(item.id);
                row.innerHTML = `
                    <div style="cursor:pointer; color:${isFav?'var(--accent)':'#333'}" onclick="toggleFav(event, '${item.id}')">★</div>
                    <img class="item-icon" src="${item.img}" loading="lazy">
                    <div class="item-name">${item.name}</div>
                    <div class="slot-badge">${item.slots} 枠</div>
                    <div class="price-group">
                        <span class="price-label">FLEA</span>
                        <span class="price-val flea-color">${item.fleaPrice.toLocaleString()}</span>
                        <span class="per-slot">@${item.fleaPerSlot.toLocaleString()}</span>
                    </div>
                    <div class="price-group">
                        <span class="price-label">${item.traderName}</span>
                        <span class="price-val ${isTraderBetter?'trader-high':'trader-color'}">${item.traderPrice.toLocaleString()}</span>
                        <span class="per-slot">@${item.traderPerSlot.toLocaleString()}</span>
                    </div>
                `;
                listDiv.appendChild(row);
            });
        }

        document.getElementById('searchInput').oninput = render;
        document.getElementById('sortSelect').onchange = render;
        document.getElementById('favFilterBtn').onclick = (e) => {
            showOnlyFav = !showOnlyFav;
            e.target.style.backgroundColor = showOnlyFav ? 'var(--accent)' : '';
            e.target.style.color = showOnlyFav ? '#000' : '';
            render();
        };
        document.getElementById('pvpBtn').onclick = () => { currentMode='pvp'; document.getElementById('pvpBtn').classList.add('active'); document.getElementById('pveBtn').classList.remove('active'); loadData(); };
        document.getElementById('pveBtn').onclick = () => { currentMode='pve'; document.getElementById('pveBtn').classList.add('active'); document.getElementById('pvpBtn').classList.remove('active'); loadData(); };
        loadData();
    </script>
</body>
</html>
