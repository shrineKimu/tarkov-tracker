<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EFT Dashboard Pro (Light)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg: #0b0b0b; --card: #161616; --accent: #ffae00; --text: #f0f0f0; --border: #333; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .status-bar { background: #000; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .mode-switch { display: flex; background: var(--card); padding: 4px; border-radius: 8px; }
        .mode-btn { padding: 6px 15px; border: none; border-radius: 4px; cursor: pointer; color: #666; background: transparent; }
        .mode-btn.active { background: var(--accent); color: #000; font-weight: bold; }

        .main-content { display: grid; grid-template-columns: 320px 1fr; flex: 1; overflow: hidden; }

        /* å·¦ï¼šãƒªã‚¹ãƒˆ */
        .sidebar { border-right: 1px solid var(--border); display: flex; flex-direction: column; background: #0f0f0f; }
        .filter-section { padding: 15px; border-bottom: 1px solid var(--border); }
        input, select { width: 100%; background: var(--card); border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 6px; margin-bottom: 10px; box-sizing: border-box; }
        
        /* ãŠæ°—ã«å…¥ã‚Šãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã®ä¸¦ã³ä¿®æ­£ */
        .fav-filter-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #888;
            cursor: pointer;
            margin-top: 5px;
        }
        .fav-filter-label input {
            width: auto !important;
            margin: 0 !important;
            cursor: pointer;
        }

        .item-list { overflow-y: auto; flex: 1; }
        .item-row { padding: 10px 15px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .item-row:hover { background: #1a1a1a; }
        .item-row img { width: 32px; height: 32px; background: #222; border-radius: 4px; }
        .fav-star { color: #444; margin-left: auto; font-size: 18px; }
        .fav-star.active { color: var(--accent); }

        /* å³ï¼šè©³ç´° */
        .detail-view { padding: 20px; overflow-y: auto; position: relative; }
        .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.7); display:none; justify-content: center; align-items: center; z-index: 10; }
        .detail-header { display: grid; grid-template-columns: 140px 1fr; gap: 20px; margin-bottom: 20px; }
        .big-icon { width: 140px; height: 140px; background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 10px; object-fit: contain; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .stat-card { background: var(--card); padding: 10px; border-radius: 8px; border: 1px solid var(--border); text-align: center; }
        .stat-val { font-size: 18px; font-weight: bold; color: var(--accent); }
        
        .chart-box { background: var(--card); border-radius: 12px; border: 1px solid var(--border); padding: 20px; height: 400px; margin-top: 20px; }
        
        @media (max-width: 768px) { .main-content { grid-template-columns: 1fr; } .sidebar { display: none; } .sidebar.active { display: flex; position: absolute; z-index: 20; width: 100%; height: 100%; } }
    </style>
</head>
<body>

<div class="status-bar">
    <div class="mode-switch">
        <button id="pvpBtn" class="mode-btn active" onclick="setMode('pvp')">PvP</button>
        <button id="pveBtn" class="mode-btn" onclick="setMode('pve')">PvE</button>
    </div>
    <div style="font-size: 12px; color: #888;">æœ€çµ‚æ›´æ–°: <span id="lastUpdate">-</span></div>
</div>

<div class="main-content">
    <div class="sidebar">
        <div class="filter-section">
            <input type="text" id="searchInput" placeholder="ã‚¢ã‚¤ãƒ†ãƒ åã‚’æ¤œç´¢..." oninput="renderList()">
            <select id="catSelect" onchange="renderList()">
                <option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>
            </select>
            <label class="fav-filter-label">
                <span>ãŠæ°—ã«å…¥ã‚Šã®ã¿</span>
                <input type="checkbox" id="favOnly" onchange="renderList()">
            </label>
        </div>
        <div id="itemList" class="item-list"></div>
    </div>

    <div class="detail-view" id="detailView" style="display:none;">
        <div id="loading" class="loading-overlay">ğŸ“Š å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <div class="detail-header">
            <img id="mainIcon" src="" class="big-icon">
            <div>
                <h2 id="mainName" style="margin:0 0 10px 0;">ã‚¢ã‚¤ãƒ†ãƒ å</h2>
                <div class="stat-grid">
                    <div class="stat-card">ç¾åœ¨å€¤<div id="curPrice" class="stat-val">-</div></div>
                    <div class="stat-card">æœ€é«˜å€¤<div id="maxPrice" class="stat-val">-</div></div>
                    <div class="stat-card">æœ€ä½å€¤<div id="minPrice" class="stat-val">-</div></div>
                </div>
            </div>
        </div>
        <div class="chart-box"><canvas id="mainChart"></canvas></div>
    </div>
</div>

<script>
    let currentItems = []; // è»½é‡ãƒªã‚¹ãƒˆç”¨
    let fullHistory = [];  // å·¨å¤§ãªå±¥æ­´ç”¨ï¼ˆå¿…è¦ãªæ™‚ã ã‘ãƒ­ãƒ¼ãƒ‰ï¼‰
    let currentMode = 'pvp';
    let chart = null;
    let favorites = JSON.parse(localStorage.getItem('eft_favs') || '[]');

    const categoryList = ["ã‚¢ã‚µãƒ«ãƒˆã‚«ãƒ¼ãƒ“ãƒ³", "ã‚¢ã‚µãƒ«ãƒˆãƒ©ã‚¤ãƒ•ãƒ«", "ã‚¤ãƒ³ã‚¹ãƒªãƒ³", "ã‚­ãƒ¼ã‚«ãƒ¼ãƒ‰", "ã‚µãƒ–ãƒã‚·ãƒ³ã‚¬ãƒ³", "ã‚·ãƒ§ãƒƒãƒˆã‚¬ãƒ³", "ã‚¹ãƒŠã‚¤ãƒ‘ãƒ¼ãƒ©ã‚¤ãƒ•ãƒ«", "ãƒ”ã‚¹ãƒˆãƒ«", "ãƒãƒ¼ã‚¯ã‚¹ãƒãƒ³ãƒ©ã‚¤ãƒ•ãƒ«", "ãƒã‚·ãƒ³ã‚¬ãƒ³", "ãƒ©ã‚¤ãƒˆãƒã‚·ãƒ³ã‚¬ãƒ³", "ãƒªãƒœãƒ«ãƒãƒ¼", "åŒ»ç™‚å“", "å¼¾è–¬", "é£Ÿæ–™", "éµ"];
    const trans = { "Arm Band": "è…•ç« ", "Armor Plate": "ã‚¢ãƒ¼ãƒãƒ¼ãƒ—ãƒ¬ãƒ¼ãƒˆ", "Auxiliary Mod": "è£œåŠ©ãƒ‘ãƒ¼ãƒ„", "Compass": "ã‚³ãƒ³ãƒ‘ã‚¹", "Face Cover": "ãƒ•ã‚§ã‚¤ã‚¹ã‚«ãƒãƒ¼", "Fuel": "ç‡ƒæ–™", "Headwear": "ãƒ˜ãƒƒãƒ‰ã‚¦ã‚§ã‚¢", "Keycard": "ã‚­ãƒ¼ã‚«ãƒ¼ãƒ‰", "Mechanical Key": "ãƒ¡ã‚«ãƒ‹ã‚«ãƒ«ã‚­ãƒ¼", "Repair Kits": "ä¿®ç†ã‚­ãƒƒãƒˆ", "Stimulant": "æ³¨å…¥å™¨(ã‚¹ãƒ†ã‚£ãƒ )", "Thermal Vision": "ã‚µãƒ¼ãƒãƒ«ãƒ“ã‚¸ãƒ§ãƒ³" };

    async function init() {
        const res = await fetch(`list-${currentMode}.json`);
        const data = await res.json();
        currentItems = data.items;
        document.getElementById('lastUpdate').innerText = new Date(data.time).toLocaleString();
        
        const sel = document.getElementById('catSelect');
        sel.innerHTML = '<option value="">ã™ã¹ã¦ã®ã‚«ãƒ†ã‚´ãƒª</option>';
        categoryList.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
        
        fullHistory = []; 
        renderList();
    }

    function renderList() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const cat = document.getElementById('catSelect').value;
        const favOnly = document.getElementById('favOnly').checked;
        const listDiv = document.getElementById('itemList');
        
        const filtered = currentItems.filter(i => {
            const cName = trans[i.category?.name] || i.category?.name || "ãã®ä»–";
            const isFav = favorites.includes(i.id);
            return i.name.toLowerCase().includes(search) && (!cat || cName === cat) && (!favOnly || isFav);
        });

        listDiv.innerHTML = filtered.slice(0, 100).map(i => `
            <div class="item-row" onclick="showDetail('${i.id}')">
                <img src="images/${i.id}.png" loading="lazy">
                <span style="font-size:12px">${i.name}</span>
                <span class="fav-star ${favorites.includes(i.id)?'active':''}" onclick="toggleFav('${i.id}', event)">â˜…</span>
            </div>`).join('');
    }

    async function showDetail(id) {
        document.getElementById('detailView').style.display = 'block';
        
        if (fullHistory.length === 0) {
            document.getElementById('loading').style.display = 'flex';
            const res = await fetch(`data-${currentMode}.json`);
            fullHistory = await res.json();
            document.getElementById('loading').style.display = 'none';
        }

        const labels = [], prices = [];
        let itemInfo = null;

        fullHistory.forEach(entry => {
            const item = entry.items.find(i => i.id === id);
            if(item) {
                labels.push(new Date(entry.time).toLocaleString('ja-JP', {month:'short', day:'2-digit', hour:'2-digit'}));
                prices.push(item.lastLowPrice);
                itemInfo = item;
            }
        });

        if(!itemInfo) return;

        document.getElementById('mainIcon').src = `images/${id}.png`;
        document.getElementById('mainName').innerText = itemInfo.name;
        document.getElementById('curPrice').innerText = prices[prices.length-1].toLocaleString() + " â‚½";
        document.getElementById('maxPrice').innerText = Math.max(...prices).toLocaleString() + " â‚½";
        document.getElementById('minPrice').innerText = Math.min(...prices).toLocaleString() + " â‚½";

        if(chart) chart.destroy();
        chart = new Chart(document.getElementById('mainChart'), {
            type: 'line',
            data: { labels, datasets: [{ label: 'Price', data: prices, borderColor: '#ffae00', tension: 0.1, fill: true, backgroundColor: 'rgba(255,174,0,0.05)' }] },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function setMode(m) {
        currentMode = m;
        document.getElementById('pvpBtn').classList.toggle('active', m === 'pvp');
        document.getElementById('pveBtn').classList.toggle('active', m === 'pve');
        init();
    }

    function toggleFav(id, e) {
        e.stopPropagation();
        if(favorites.includes(id)) favorites = favorites.filter(f => f !== id);
        else favorites.push(id);
        localStorage.setItem('eft_favs', JSON.stringify(favorites));
        renderList();
    }

    init();
</script>
</body>
</html>
