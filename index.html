<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Tarkov Price Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #eee; margin: 20px; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        input, select, button { padding: 8px; border-radius: 4px; border: 1px solid #444; background: #2a2a2a; color: #fff; }
        
        .item-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .item-card { background: #2a2a2a; padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; border: 1px solid #333; }
        .item-card:hover { border-color: #007bff; background: #333; }
        .item-card img { width: 64px; height: 64px; object-fit: contain; display: block; margin: 0 auto 10px; }
        .item-name { font-size: 0.9em; font-weight: bold; height: 2.8em; overflow: hidden; }
        .item-price { color: #ffca28; font-size: 1.1em; margin-top: 5px; }
        .per-slot { font-size: 0.8em; color: #aaa; }

        /* モーダル */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: #2a2a2a; margin: 5% auto; padding: 20px; width: 90%; max-width: 800px; border-radius: 10px; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 20px; font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>Tarkov Price Tracker</h2>

    <div class="controls">
        <select id="modeSelect" onchange="changeMode(this.value)">
            <option value="pvp">PvP Mode</option>
            <option value="pve">PvE Mode</option>
        </select>
        <input type="text" id="search" placeholder="アイテム名で検索..." oninput="render()">
        <select id="categorySelect" onchange="render()"></select>
        <div id="updateTime" style="font-size: 0.8em; color: #888;"></div>
    </div>

    <div id="itemList" class="item-list"></div>

    <div id="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalInfo" style="margin-bottom: 15px; font-size: 0.9em; color: #ccc;"></div>
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <script>
        let items = [];         // list-xxx.json の中身
        let historyStore = {};  // data-xxx.json の中身 (一度読み込んだら保持)
        let currentMode = 'pvp';
        let chart = null;

        async function init() {
            await changeMode('pvp');
        }

        async function changeMode(mode) {
            currentMode = mode;
            historyStore = {}; // モードが変わったら履歴キャッシュをクリア
            
            try {
                const res = await fetch(`list-${mode}.json`);
                const data = await res.json();
                items = data.items;
                document.getElementById('updateTime').innerText = `最終更新: ${new Date(data.time).toLocaleString()}`;

                // カテゴリ一覧の作成
                const cats = [...new Set(items.map(i => i.category))].sort();
                const catSelect = document.getElementById('categorySelect');
                catSelect.innerHTML = '<option value="">すべてのカテゴリ</option>' + 
                    cats.map(c => `<option value="${c}">${c}</option>`).join('');

                render();
            } catch (e) {
                console.error("データの読み込みに失敗しました", e);
            }
        }

        function render() {
            const query = document.getElementById('search').value.toLowerCase();
            const cat = document.getElementById('categorySelect').value;
            const listEl = document.getElementById('itemList');

            const filtered = items.filter(i => {
                const matchName = i.name.toLowerCase().includes(query) || i.shortName?.toLowerCase().includes(query);
                const matchCat = !cat || i.category === cat;
                return matchName && matchCat;
            });

            // 1マス単価の高い順に並び替え
            filtered.sort((a, b) => {
                const priceA = historyStore[a.id]?.cp || 0;
                const priceB = historyStore[b.id]?.cp || 0;
                return (priceB / b.slots) - (priceA / a.slots);
            });

            listEl.innerHTML = filtered.map(i => {
                // historyStoreに最新価格があれば表示、なければ「詳細を表示」
                const price = historyStore[i.id]?.cp || "---";
                const perSlot = price !== "---" ? Math.floor(price / i.slots).toLocaleString() : "??";
                
                return `
                <div class="item-card" onclick="showDetail('${i.id}')">
                    <img src="${i.img}" alt="">
                    <div class="item-name">${i.name}</div>
                    <div class="item-price">${price.toLocaleString()} ₽</div>
                    <div class="per-slot">1マス: ${perSlot} ₽</div>
                </div>`;
            }).join('');
        }

        async function showDetail(id) {
            const item = items.find(i => i.id === id);
            const modal = document.getElementById('modal');
            modal.style.display = 'block';
            document.getElementById('modalTitle').innerText = item.name;

            // 履歴データの読み込み（まだ持っていなければ）
            if (Object.keys(historyStore).length === 0) {
                const res = await fetch(`data-${currentMode}.json`);
                const json = await res.json();
                historyStore = json.data;
                render(); // メイン一覧の価格表示を更新
            }

            const history = historyStore[id]?.h || [];
            
            // スペック情報の表示
            let infoText = `カテゴリ: ${item.category} | サイズ: ${item.slots}マス | 店売り: ${item.bestTraderPrice.toLocaleString()} ₽ (${item.bestTraderName})`;
            if (item.props.damage) infoText += `<br>ダメージ: ${item.props.damage} | 貫通力: ${item.props.penetrationPower}`;
            if (item.props.class) infoText += `<br>アーマークラス: ${item.props.class} | 耐久値: ${item.props.durability}`;
            document.getElementById('modalInfo').innerHTML = infoText;

            // グラフ描画
            const ctx = document.getElementById('priceChart').getContext('2d');
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(h => new Date(h.t).toLocaleString()),
                    datasets: [{
                        label: 'Flea Market Price',
                        data: history.map(h => h.p),
                        borderColor: '#007bff',
                        tension: 0.1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: false, grid: { color: '#444' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function closeModal() {
            document.getElementById('modal').style.display = 'none';
        }

        window.onclick = (event) => {
            if (event.target == document.getElementById('modal')) closeModal();
        };

        init();
    </script>
</body>
</html>
