<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Tarkov Price Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #eee; margin: 20px; }
        .controls { margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        input, select, button { padding: 8px; border-radius: 4px; border: 1px solid #444; background: #2a2a2a; color: #fff; }
        
        .item-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .item-card { background: #2a2a2a; padding: 10px; border-radius: 8px; cursor: pointer; transition: 0.2s; border: 1px solid #333; }
        .item-card:hover { border-color: #007bff; background: #333; }
        .item-card img { width: 64px; height: 64px; object-fit: contain; display: block; margin: 0 auto 10px; }
        .item-name { font-size: 0.9em; font-weight: bold; height: 2.8em; overflow: hidden; }
        .item-price { color: #ffca28; font-size: 1.1em; margin-top: 5px; }
        .per-slot { font-size: 0.8em; color: #aaa; }

        /* モーダル */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); }
        .modal-content { background: #2a2a2a; margin: 5% auto; padding: 20px; width: 90%; max-width: 800px; border-radius: 10px; position: relative; }
        .close-btn { position: absolute; top: 10px; right: 20px; font-size: 24px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>Tarkov Price Tracker</h2>

    <div class="controls">
        <select id="modeSelect" onchange="changeMode(this.value)">
            <option value="pvp">PvP Mode</option>
            <option value="pve">PvE Mode</option>
        </select>
        <input type="text" id="search" placeholder="アイテム名で検索..." oninput="render()">
        <select id="categorySelect" onchange="render()"></select>
        <div id="updateTime" style="font-size: 0.8em; color: #888;"></div>
    </div>

    <div id="itemList" class="item-list"></div>

    <div id="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h3 id="modalTitle"></h3>
            <div id="modalInfo" style="margin-bottom: 15px; font-size: 0.9em; color: #ccc;"></div>
            <canvas id="priceChart"></canvas>
        </div>
    </div>
    
    <script>
        let items = [];         
        let historyStore = {};  
        let currentMode = 'pvp';
        let chart = null;

        async function init() {
            await changeMode('pvp');
        }

        async function changeMode(mode) {
            currentMode = mode;
            // モード切替時に履歴キャッシュをリセット
            historyStore = {}; 
            
            try {
                const res = await fetch(`list-${mode}.json`);
                const data = await res.json();
                items = data.items; //
                document.getElementById('updateTime').innerText = `最終更新: ${new Date(data.time).toLocaleString()}`;

                // カテゴリ生成
                const cats = [...new Set(items.map(i => i.category))].sort();
                const catSelect = document.getElementById('categorySelect');
                catSelect.innerHTML = '<option value="">すべてのカテゴリ</option>' + 
                    cats.map(c => `<option value="${c}">${c}</option>`).join('');

                // 最初に一度データファイルを読み込んで価格を表示させる
                await loadPriceData();
                render();
            } catch (e) {
                console.error("データロード失敗", e);
            }
        }

        async function loadPriceData() {
            const res = await fetch(`data-${currentMode}.json`);
            const json = await res.json();
            historyStore = json.data; //
        }

        function render() {
            const query = document.getElementById('search').value.toLowerCase();
            const cat = document.getElementById('categorySelect').value;
            const listEl = document.getElementById('itemList');

            const filtered = items.filter(i => {
                const matchName = i.name.toLowerCase().includes(query) || i.shortName?.toLowerCase().includes(query);
                const matchCat = !cat || i.category === cat;
                return matchName && matchCat;
            });

            // フリマ最低価格(cp)に基づいた「1マス単価」で降順ソート
            filtered.sort((a, b) => {
                const priceA = historyStore[a.id]?.cp || 0;
                const priceB = historyStore[b.id]?.cp || 0;
                const perSlotA = priceA / (a.slots || 1);
                const perSlotB = priceB / (b.slots || 1);
                return perSlotB - perSlotA;
            });

            listEl.innerHTML = filtered.map(i => {
                const price = historyStore[i.id]?.cp || 0;
                const perSlot = Math.floor(price / (i.slots || 1));
                
                return `
                <div class="item-card" onclick="showDetail('${i.id}')">
                    <img src="${i.img}" alt="">
                    <div class="item-name">${i.name}</div>
                    <div class="item-price" style="color: #ffca28;">最低: ${price.toLocaleString()} ₽</div>
                    <div class="per-slot">1マス: ${perSlot.toLocaleString()} ₽</div>
                </div>`;
            }).join('');
        }

        async function showDetail(id) {
            const item = items.find(i => i.id === id);
            const modal = document.getElementById('modal');
            modal.style.display = 'block';
            document.getElementById('modalTitle').innerText = item.name;

            // 履歴(h)からグラフを作成
            const history = historyStore[id]?.h || [];
            
            let infoText = `サイズ: ${item.slots}マス | 店売り最高: ${item.bestTraderPrice.toLocaleString()} ₽ (${item.bestTraderName})`;
            if (item.props.damage) infoText += `<br>弾薬性能: ダメージ ${item.props.damage} / 貫通 ${item.props.penetrationPower}`;
            document.getElementById('modalInfo').innerHTML = infoText;

            const ctx = document.getElementById('priceChart').getContext('2d');
            if (chart) chart.destroy();

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: history.map(h => new Date(h.t).toLocaleTimeString()),
                    datasets: [{
                        label: 'フリマ最低価格推移',
                        data: history.map(h => h.p),
                        borderColor: '#ffca28',
                        backgroundColor: 'rgba(255, 202, 40, 0.1)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { labels: { color: '#fff' } } },
                    scales: {
                        y: { grid: { color: '#333' }, ticks: { color: '#aaa' } },
                        x: { grid: { display: false }, ticks: { color: '#aaa' } }
                    }
                }
            });
        }

        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        init();
    </script>
</body>
</html>
